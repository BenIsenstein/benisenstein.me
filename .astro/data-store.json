[["Map",1,2,9,10],"meta::meta",["Map",3,4,5,6,7,8],"astro-version","5.1.5","content-config-digest","a0b11e2257ef70a7","astro-config-digest","{\"root\":{},\"srcDir\":{},\"publicDir\":{},\"outDir\":{},\"cacheDir\":{},\"compressHTML\":true,\"base\":\"/\",\"trailingSlash\":\"ignore\",\"output\":\"static\",\"scopedStyleStrategy\":\"attribute\",\"build\":{\"format\":\"directory\",\"client\":{},\"server\":{},\"assets\":\"_astro\",\"serverEntry\":\"entry.mjs\",\"redirects\":true,\"inlineStylesheets\":\"auto\",\"concurrency\":1},\"server\":{\"open\":true,\"host\":false,\"port\":4321,\"streaming\":true},\"redirects\":{},\"image\":{\"endpoint\":{\"route\":\"/_image\"},\"service\":{\"entrypoint\":\"astro/assets/services/sharp\",\"config\":{}},\"domains\":[],\"remotePatterns\":[]},\"devToolbar\":{\"enabled\":true},\"markdown\":{\"syntaxHighlight\":\"shiki\",\"shikiConfig\":{\"langs\":[],\"langAlias\":{},\"theme\":\"github-dark\",\"themes\":{},\"wrap\":false,\"transformers\":[]},\"remarkPlugins\":[],\"rehypePlugins\":[],\"remarkRehype\":{},\"gfm\":true,\"smartypants\":true},\"security\":{\"checkOrigin\":true},\"env\":{\"schema\":{},\"validateSecrets\":false},\"experimental\":{\"clientPrerender\":false,\"contentIntellisense\":false,\"responsiveImages\":false},\"legacy\":{\"collections\":false}}","blog",["Map",11,12,42,43,63,64],"launch",{"id":11,"data":13,"body":18,"filePath":19,"digest":20,"rendered":21},{"title":14,"published":15,"datePublished":16,"dateLastUpdated":17},"I'm Starting a Blog! (Hi Mom)",true,["Date","2025-02-18T00:00:00.000Z"],["Date","2025-02-18T00:00:00.000Z"],"It's astonishing just how many things can stay floating around in one's mind for years. Little tidbits, anecdotes. Nuggets of wisdom dispensed by elders and mentors. Personal case studies on how some little discovery helped you communicate better, reduced the mental load of some task, or simply made everything *click*.\n\nThis is a blog about software development. Programming, terminals, code editors, servers, databases, networking, containers, cloud, CI/CD, open source, web browsers, web frameworks, auth, AI tools, design tools, user interfaces. All of it.\n\nThis is also a journal of sorts, in which I'll try to untangle and re-thread some of the tidbits, anecdotes, and insights that have been brewing over my twenty-six years. Topics that hold my interest include \u003Ca href=\"https://www.instagram.com/p/B8SxBijlegQ/\" target=\"_blank\">music\u003C/a>, dance, creativity, flow, and the habits of high-impact individuals.\n\n## Math, Mountains, Music\n\nAround the age of six, I showed a natural talent for numbers. I could perform arithmetic in my head more than most kids my age. But it wasn't just arithmetic that came naturally--it was the relations among numbers, geometric proportions, the beauty of equations. It was *pattern recognition* that truly captivated me. In fact, one of my favorite little hobbies involved arranging the vegetables on my plate into patterns at dinner time, which amused my mother.\n\nFrom the same period, I have my first memories of the Canadian Rocky Mountains around my hometown of Calgary. To say that those mountains are foundational to the person I am is not far off. Since the age of six, I have had countless formative experiences in the Canadian Rockies. I have hiked, climbed, scrambled, camped, and paddled for over a year in total in the Canadian wilderness. These experiences helped me develop resilience, leadership, and reverence and respect for nature.\n\nBy the age of ten, I was fascinated with both of these things, patterns and nature. Then I got into music, which is arguably the most *human* way of combining the two. Repeating patterns of sound that represent nature in a human way, that's what music is to me. At least, that's one story of what music is to me. Music, like any complex phenomenon, contains many narratives, some of which may even be contradictory, that all contribute to the rich and beautiful whole. It is multi-faceted, as is much of life.\n\n## Creativity and Practice\n\nIt was while studying for my undergrad in music that I learned about the nature of creativity, and the vital importance of practice. Getting to spend those years surrounded by mentors and other passionate young musicians was very enriching for me. \n\nThe greatest musical improvisers are both stunning virtuosos on their instruments, and composers who have gained an incredibly profound sense for how music develops. They practice all sorts of different material, sometimes without an obvious connection to future music-making. They practice melodic patterns, rhythms, musical ideas of all kinds, experimenting, combining and recombining these ideas to find the patterns that feel just right. They build a musical palette that sits right inside their nervous system, embodied possibility waiting to be unleashed.\n\nEventually, movements in music of truly infinite possibility flow out of great improvising musicians, both individually and in groups. If you've ever been in the presence of a band that just seem to be jamming on another level, this is what's behind all that.\n\nWhat I began to understand is that there are levels to creativity. Creativity can only be achieved once a practitioner acquires *deep domain knowledge*. While deep knowledge can enable rich creation in a narrow domain, the amount of novel combinations only skyrockets when knowledge is *both deep and broad*. This is no easy feat.\n\n## Still Practicing\n\nIn any domain, mastery requires dedicated practice. Day in and day out. For years.\n\nToday I'm still hard at work, practicing the art of spotting patterns and creating natural experiences for people. I'm pursuing this by being the best software developer I can be.\n\nI *practice the fundamentals*, right down to how I operate my keyboard. I work toward having *deep domain knowledge* on compute, memory, storage, and network. I take what's been computed, stored, and transmitted, and present people with *user interfaces* that have been *designed thoughtfully*. I practice combining and recombining to create *rich, purpose-built software* that truly adds value to the life of someone in some way.\n\nAnd when it all comes together, it's (almost) as beautiful as a great symphony. Almost.\n\n## Let's Connect\n\nIf my story or ideas appeal to you, then please connect on [LinkedIn](https://www.linkedin.com/in/benisenstein/) or [GitHub](https://github.com/BenIsenstein).","src/collections/blog/launch.md","951d665851f6ee4f",{"html":22,"metadata":23},"\u003Cp>Itâ€™s astonishing just how many things can stay floating around in oneâ€™s mind for years. Little tidbits, anecdotes. Nuggets of wisdom dispensed by elders and mentors. Personal case studies on how some little discovery helped you communicate better, reduced the mental load of some task, or simply made everything \u003Cem>click\u003C/em>.\u003C/p>\n\u003Cp>This is a blog about software development. Programming, terminals, code editors, servers, databases, networking, containers, cloud, CI/CD, open source, web browsers, web frameworks, auth, AI tools, design tools, user interfaces. All of it.\u003C/p>\n\u003Cp>This is also a journal of sorts, in which Iâ€™ll try to untangle and re-thread some of the tidbits, anecdotes, and insights that have been brewing over my twenty-six years. Topics that hold my interest include \u003Ca href=\"https://www.instagram.com/p/B8SxBijlegQ/\" target=\"_blank\">music\u003C/a>, dance, creativity, flow, and the habits of high-impact individuals.\u003C/p>\n\u003Ch2 id=\"math-mountains-music\">Math, Mountains, Music\u003C/h2>\n\u003Cp>Around the age of six, I showed a natural talent for numbers. I could perform arithmetic in my head more than most kids my age. But it wasnâ€™t just arithmetic that came naturallyâ€”it was the relations among numbers, geometric proportions, the beauty of equations. It was \u003Cem>pattern recognition\u003C/em> that truly captivated me. In fact, one of my favorite little hobbies involved arranging the vegetables on my plate into patterns at dinner time, which amused my mother.\u003C/p>\n\u003Cp>From the same period, I have my first memories of the Canadian Rocky Mountains around my hometown of Calgary. To say that those mountains are foundational to the person I am is not far off. Since the age of six, I have had countless formative experiences in the Canadian Rockies. I have hiked, climbed, scrambled, camped, and paddled for over a year in total in the Canadian wilderness. These experiences helped me develop resilience, leadership, and reverence and respect for nature.\u003C/p>\n\u003Cp>By the age of ten, I was fascinated with both of these things, patterns and nature. Then I got into music, which is arguably the most \u003Cem>human\u003C/em> way of combining the two. Repeating patterns of sound that represent nature in a human way, thatâ€™s what music is to me. At least, thatâ€™s one story of what music is to me. Music, like any complex phenomenon, contains many narratives, some of which may even be contradictory, that all contribute to the rich and beautiful whole. It is multi-faceted, as is much of life.\u003C/p>\n\u003Ch2 id=\"creativity-and-practice\">Creativity and Practice\u003C/h2>\n\u003Cp>It was while studying for my undergrad in music that I learned about the nature of creativity, and the vital importance of practice. Getting to spend those years surrounded by mentors and other passionate young musicians was very enriching for me.\u003C/p>\n\u003Cp>The greatest musical improvisers are both stunning virtuosos on their instruments, and composers who have gained an incredibly profound sense for how music develops. They practice all sorts of different material, sometimes without an obvious connection to future music-making. They practice melodic patterns, rhythms, musical ideas of all kinds, experimenting, combining and recombining these ideas to find the patterns that feel just right. They build a musical palette that sits right inside their nervous system, embodied possibility waiting to be unleashed.\u003C/p>\n\u003Cp>Eventually, movements in music of truly infinite possibility flow out of great improvising musicians, both individually and in groups. If youâ€™ve ever been in the presence of a band that just seem to be jamming on another level, this is whatâ€™s behind all that.\u003C/p>\n\u003Cp>What I began to understand is that there are levels to creativity. Creativity can only be achieved once a practitioner acquires \u003Cem>deep domain knowledge\u003C/em>. While deep knowledge can enable rich creation in a narrow domain, the amount of novel combinations only skyrockets when knowledge is \u003Cem>both deep and broad\u003C/em>. This is no easy feat.\u003C/p>\n\u003Ch2 id=\"still-practicing\">Still Practicing\u003C/h2>\n\u003Cp>In any domain, mastery requires dedicated practice. Day in and day out. For years.\u003C/p>\n\u003Cp>Today Iâ€™m still hard at work, practicing the art of spotting patterns and creating natural experiences for people. Iâ€™m pursuing this by being the best software developer I can be.\u003C/p>\n\u003Cp>I \u003Cem>practice the fundamentals\u003C/em>, right down to how I operate my keyboard. I work toward having \u003Cem>deep domain knowledge\u003C/em> on compute, memory, storage, and network. I take whatâ€™s been computed, stored, and transmitted, and present people with \u003Cem>user interfaces\u003C/em> that have been \u003Cem>designed thoughtfully\u003C/em>. I practice combining and recombining to create \u003Cem>rich, purpose-built software\u003C/em> that truly adds value to the life of someone in some way.\u003C/p>\n\u003Cp>And when it all comes together, itâ€™s (almost) as beautiful as a great symphony. Almost.\u003C/p>\n\u003Ch2 id=\"lets-connect\">Letâ€™s Connect\u003C/h2>\n\u003Cp>If my story or ideas appeal to you, then please connect on \u003Ca href=\"https://www.linkedin.com/in/benisenstein/\">LinkedIn\u003C/a> or \u003Ca href=\"https://github.com/BenIsenstein\">GitHub\u003C/a>.\u003C/p>",{"headings":24,"imagePaths":38,"frontmatter":39},[25,29,32,35],{"depth":26,"slug":27,"text":28},2,"math-mountains-music","Math, Mountains, Music",{"depth":26,"slug":30,"text":31},"creativity-and-practice","Creativity and Practice",{"depth":26,"slug":33,"text":34},"still-practicing","Still Practicing",{"depth":26,"slug":36,"text":37},"lets-connect","Letâ€™s Connect",[],{"title":14,"published":15,"datePublished":40,"dateLastUpdated":41},["Date","2025-02-18T00:00:00.000Z"],["Date","2025-02-18T00:00:00.000Z"],"future_paragraph",{"id":42,"data":44,"body":49,"filePath":50,"digest":51,"rendered":52},{"title":45,"published":46,"datePublished":47,"dateLastUpdated":48},"Bit on the Future of Tech and Society",false,["Date","2025-02-18T00:00:00.000Z"],["Date","2025-02-18T00:00:00.000Z"],"This is also a blog about tech in the world. Tech for business, for career, for personal trivialities, for fitness, for music, for reading, for movies, for news, for automation, for banking and payments, for travel and gaming and hosting events and philanthropy and fundraising and meeting people and on and on.\n\n## The Future of Tech and Society\n\nDevices and software of all kinds have undoubtedly transformed the lives of almost everyone on Earth in the last 30 years. The open question that everyone is struggling to answer, however, is how we progress from *information overwhelm and social dysfunction* to a more desireable future that looks something like *tech-facilitated security, prosperity, and robustness*. Much of that vision may actually involve having our tech get out of the way so we can be plain old human beings more of the time.","src/collections/blog/future_paragraph.md","a2354a0055784d41",{"html":53,"metadata":54},"\u003Cp>This is also a blog about tech in the world. Tech for business, for career, for personal trivialities, for fitness, for music, for reading, for movies, for news, for automation, for banking and payments, for travel and gaming and hosting events and philanthropy and fundraising and meeting people and on and on.\u003C/p>\n\u003Ch2 id=\"the-future-of-tech-and-society\">The Future of Tech and Society\u003C/h2>\n\u003Cp>Devices and software of all kinds have undoubtedly transformed the lives of almost everyone on Earth in the last 30 years. The open question that everyone is struggling to answer, however, is how we progress from \u003Cem>information overwhelm and social dysfunction\u003C/em> to a more desireable future that looks something like \u003Cem>tech-facilitated security, prosperity, and robustness\u003C/em>. Much of that vision may actually involve having our tech get out of the way so we can be plain old human beings more of the time.\u003C/p>",{"headings":55,"imagePaths":59,"frontmatter":60},[56],{"depth":26,"slug":57,"text":58},"the-future-of-tech-and-society","The Future of Tech and Society",[],{"title":45,"published":46,"datePublished":61,"dateLastUpdated":62},["Date","2025-02-18T00:00:00.000Z"],["Date","2025-02-18T00:00:00.000Z"],"supabase_auth_sessions_ssr",{"id":63,"data":65,"body":69,"filePath":70,"digest":71,"rendered":72},{"title":66,"published":15,"datePublished":67,"dateLastUpdated":68},"On Server-Side Supabase Auth in the SSR Era",["Date","2025-11-12T00:00:00.000Z"],["Date","2025-11-12T00:00:00.000Z"],"Pasting some thoughts which I shared regarding an issue on the `/supabase/ssr` GitHub repo. The issue is still active, and you can follow the discussion here: [AuthApiError: Invalid Refresh Token: Refresh Token Not Found when refreshing token in middleware](https://github.com/supabase/ssr/issues/68).\n\nDevelopers building NextJS apps which refresh Supabase Auth sessions on both the server and client are seeing their users logged out seemingly randomly. This is a massive problem that needs to be understood and solved, but I try to explain that it's not random, and that there are some things we can do about it starting now.\n\nIt's my feeling that having a deeper understanding of Supabase in general really is our path towards being more robust in our app dev work. Here we go!\n\n## The Issue Beneath The Issue\n\nI first encountered the *\"issue beneath the issue\"* in the `/supabase/auth-js` repo --- that is, shared state between Supabase `GoTrueClient` instances is no longer just in one browser, it needs to be managed across **networked instances**. The issue there was about the expectation that browser-side `onAuthStateChange()` should listen for **all auth state updates** including on the server, which is not what that function does.\n\nI'm going to explain what that function actually does, and address our new modern issue of syncing auth state across increasingly distributed services that can't always stay subscribed to eachother in a direct \"pub-sub\" sort of way. The problem at the heart of this is **race conditions emerging** between `GoTrueClient` instances, wherein the client that lost the race to refresh the shared session fails with `Invalid Refresh Token`.\n\nWe need to solve the problem of synced session state between server-side and browser-side supabase clients. However, the behaviour of `onAuthStateChange()` is a feature not a bug, and the solution to our problem lies elsewhere in our application architecture.\n\n## onAuthStateChange() is only in the browser, by design\n\nThe `GoTrueClient.onAuthStateChange()` function was designed back in the browser-only days of SPAs, to sync **across tabs and windows** that may be running multiple instances of a web app at the same time. If you dig into the source code of the auth client, you'll see that all instances of the client running on the same browser (across tabs and windows) take advantage of the [broadcast channel API](https://developer.mozilla.org/en-US/blog/exploring-the-broadcast-channel-api-for-cross-tab-communication/) and a shared locking mechanism to ensure that when it's time to refresh the session, it takes place **only once, done by a single client instance.** Here is a common `useEffect()` to handle auth state changes in a React SPA:\n\n```ts\nuseEffect(() => {\n  // Fetch logged in user on mount\n  supabase.auth.getUser().then(response => {\n    setUser(response.data.user)\n  })\n  \n  // Track any changes in local state\n  const listener = supabase.auth.onAuthStateChange(async (event, session) => {\n    setUser(session?.user || null)\n  })\n\n  return () => listener.data.subscription.unsubscribe()\n}, [])\n```\n\n## How a shared lock prevents race conditions\n\nAlmost every function call that goes to the GoTrue server needs to acquire the lock first. Let's take this example of the `GoTrueClient.getUser()` method:\n\n```ts\n// getUser()\n\nconst result = await this._acquireLock(-1, async () => {\n      return await this._getUser()\n})\n```\n\nSo, in the browser-only paradigm of SPAs in early 2020s, the session refresh happens in the context that this client is the only one manipulating auth state for our current user, and **we can be sure of that because of the locking across all tabs and windows.**\n\n`getUser()` actually makes a network call every time, it never pulls the user from the local storage interface like it does with `getSession()`. So in order to fetch the user, the function closure needs to make sure it sends a non-expired access token, and to do that, `getUser()` calls an internal method `_getUser()`, which itself uses a `_useSession()` wrapper that makes a non-expired access token available:\n\n```ts\n// _getUser()\n\nreturn await this._useSession(async (result) => {\n        const { data, error } = result\n        if (error) {\n          throw error\n        }\n\n        // returns an error if there is no access_token or custom authorization header\n        if (!data.session?.access_token && !this.hasCustomAuthorizationHeader) {\n          return { data: { user: null }, error: new AuthSessionMissingError() }\n        }\n\n        return await _request(this.fetch, 'GET', `${this.url}/user`, {\n          headers: this.headers,\n          jwt: data.session?.access_token ?? undefined,\n          xform: _userResponse,\n        })\n})\n```\n\nWhat does the `_useSession()` higher-order function wrapper do you ask? We can infer from context that it takes the passed callback function, and makes sure it has access to an up-to-date access token before calling it. But the details are so important to understand that I'm going to paste the function here with some less important parts edited out:\n\n\n```ts\n// _useSession() and __loadSession()\n\n/**\n   * Use instead of getSession() inside the library. It is\n   * semantically usually what you want, as getting a session involves some\n   * processing afterwards that requires only one client operating on the\n   * session at once across multiple tabs or processes.\n   */\n  private async _useSession\u003CR>(fn): Promise\u003CR> {\n    try {\n      const result = await this.__loadSession()\n\n      return await fn(result)\n    } finally {\n      this._debug('#_useSession', 'end')\n    }\n  }\n\n  /**\n   * NEVER USE DIRECTLY!\n   *\n   * Always use useSession().\n   */\n  private async __loadSession(): Promise\u003C{data: {session: Session}, error: null}> {\n    try {\n      let currentSession: Session | null = null\n\n      // try to get session information in the default place it should be, almost always from browser cookies API\n      currentSession = await getItemAsync(this.storage, this.storageKey)\n\n      if (!currentSession) {\n        return { data: { session: null }, error: null }\n      }\n\n      // A session is considered expired before the access token _actually_\n      // expires. When the autoRefreshToken option is off (or when the tab is\n      // in the background), very eager users of getSession() -- like\n      // realtime-js -- might send a valid JWT which will expire by the time it\n      // reaches the server.\n      const hasExpired = currentSession.expires_at\n        ? currentSession.expires_at * 1000 - Date.now() \u003C EXPIRY_MARGIN_MS\n        : false\n\n      if (!hasExpired) {\n        return { data: { session: currentSession }, error: null }\n      }\n\n      const { session, error } = await this._callRefreshToken(currentSession.refresh_token)\n      if (error) {\n        return { data: { session: null }, error }\n      }\n\n      return { data: { session }, error: null }\n    } finally {\n      this._debug('#__loadSession()', 'end')\n    }\n  }\n```\n\n We see close to the bottom that it's here, in the context of `_acquireLock()`, then inside `_useSession()`, the client notices that the session is expired (or about to expire), and calls `this._callRefreshToken(currentSession.refresh_token)`. All function calls to `getUser()`, `signIn()` etc. by other client instances in other tabs and windows **must wait for that lock to become released** and wait their turn until the new refresh/access tokens are made available. Once the session is refreshed, the lock is released and an event is broadcasted over the channel, at which point the other consuming clients execute their `onAuthStateChange()` callbacks. \n\nHere's the gist of `_callRefreshToken()`:\n```ts\n// _callRefreshToken()\n\n     const { data, error } = await this._refreshAccessToken(refreshToken)\n      if (error) throw error\n      if (!data.session) throw new AuthSessionMissingError()\n\n      await this._saveSession(data.session)\n      await this._notifyAllSubscribers('TOKEN_REFRESHED', data.session)\n```\nIt's essential to understand that the key to this method working so well in SPAs is **every consuming client is connected over a secure communication method,** the `BroadcastChannel`, which makes the new session **available instantly**.\n\n## The challenge of syncing auth session state across varied consumers\n\nGreat, now we understand how the supabase engineers tackled this thorny problem in browser-only bygone eras. The thing is, in a distributed system that's instantiating clients in multiple places at once (browser, NextJS server, edge functions, cron jobs, etc), broadcasting these stateful updates to all clients becomes impossible.\n\nExample: I have a supabase client running inside an edge function and it determines that it's time to refresh the session. It'll receive that new session and finish the work it's doing, but it has no way to share that new session info with my web app in the browser, which is now expired and failing. ğŸ˜¢\n\nThis is just a reality of distributed systems; in absence of a shared lock, multiple clients try and refresh the session at the same time. One will win, get a valid new session, and the other one will fail with `AuthApiError: Invalid Refresh Token: Refresh Token Not Found`. \n\n## Looking ahead to solutions\n\nBefore we get to handling the `Invalid Refresh Token` nightmare, let's fix the basic issue and keep the browser context synced after server-side `signIn()` and `signOut()`.\n\nIn your server actions for auth (I call them `signIn()` and `signOut()`), add a query param of `?refresh_browser_auth` to the url you redirect to on completion:\n\n```ts\n// \"/app/auth/actions.ts\"\n\nexport async function signIn(currentState: { message: string }, formData: FormData) {\n    const supabase = await createClient()\n\n    const data = {\n        email: formData.get('email') as string,\n        password: formData.get('password') as string,\n    }\n\n    const { error } = await supabase.auth.signInWithPassword(data)\n\n    if (error) {\n        return { message: error.message }\n    }\n\n    revalidatePath('/', 'layout')\n    redirect(\"/?refresh_browser_auth\")\n}\n\n\nexport async function signout() {\n    const supabase = await createClient()\n    await supabase.auth.signOut({ scope: \"local\" })\n\n    redirect(\"/?refresh_browser_auth\")\n}\n```\n\nTake the following example `useEffect()` that handles the query param. It's rendered as its own component to be able to compose inside a shared `\u003CSuspense>` boundary alongside other utilites:\n\n```ts\n// /components/UrlAuthSync.tsx\n\n\"use client\"\n\nimport { useEffect } from \"react\"\nimport { useSearchParams, useRouter, usePathname } from \"next/navigation\"\nimport { useAppContext } from \"@/lib/contexts/appContext\"\n\nexport default function UrlAuthSync() {\n    const pathname = usePathname()\n    const searchParams = useSearchParams()\n    const router = useRouter()\n    const { supabase, mergeState } = useAppContext()\n\n    useEffect(() => {\n        if (searchParams.has(\"refresh_browser_auth\")) {\n            supabase.auth.getSession().then(response => {\n                router.replace(pathname)\n                mergeState({ user: response.data.session?.user || null })\n            })\n        }\n    }, [pathname, searchParams, router, mergeState, supabase.auth])\n\n    return \u003C>\u003C/>\n}\n```\n\nImported and rendered in root layout:\n\n```ts\n// /app/layout.tsx\n\nimport UrlAuthSync from \"@/components/UrlAuthSync\"\n// ...other imports and logic\n\nexport default function RootLayout({ children }) {\n  return (\n    \u003Chtml lang=\"en\">\n      \u003Cbody>\n        \u003CAppContextProvider>\n          {children}\n          \u003CSuspense>\n            \u003CUrlToast />\n            \u003CUrlAuthSync />\n            \u003CToaster />\n          \u003C/Suspense>\n        \u003C/AppContextProvider>\n      \u003C/body>\n    \u003C/html>\n  );\n}\n```\n\nAnd that takes care of that. A flag in the url to tell the browser context that it needs to refresh in these specific scenarios.\n \nNote I'm using `getSession()` in this case, which is often discouraged by the supabase docs because it can return a stale session directly out of local storage. But in this case, directly after a user signin or signout, **it'll be up-to-date for sure** so a request to the auth server is unnecessary.\n\nBack to the `Invalid Refresh Token` nightmare --- What to do about this problem? It seems the supabase team is still figuring this out. I have some ideas:\n\n### 1. Treat the browser cookie jar as the single point of recovery\n\nThere are many scenarios that could lead to a supabase client instance being in the `Invalid Refresh Token` nightmare. Here are some common ones I can think of that might make this a bit more clear:\n\n- A server-side client is executing middleware and tries to refresh its session. It lost a race with a browser-side client that refreshed at the exact same moment, and it doesn't have access to the new session\n- A browser-side client fires off a `useQuery()` to supabase and tries to refresh its session. It lost a race with a server-side client that refreshed at the exact same moment, and it doesn't have access to the new session\n- A client in an Edge Function tried to refresh its expired session during a long-running background job, only to find that another client used up the shared refresh token in the meantime, and it doesn't have access to the new session\n\nIn all of these cases, the problem is that there is no shared lock and no shared `BroadcastChannel`. The client's refresh token is completely useless (it can only be exchanged for a new session once, by design) and there is no easy instant access to the new session.\n\nHow a supabase client instance ends up in this disaster **doesn't matter.** What we need to do is **write retry logic** that looks to the browser cookie jar then **tries again with the up-to-date session.**\n\nIn all cases --- during the rendering of RSC pages or components, during middleware, during API routes, during server actions, during a browser `useQuery`, or some Edge Function in a faraway land --- **an error message has to make its way back to the calling function in the browser.** There, we can wait until the new session has made its way into the browser cookies, and retry that page navigation or API call.\n\nIn order for this strategy to work, we have to trust that **every new session will be stored in browser cookies,** which takes me to my second recommendation:\n\n### 2. Only refresh an auth session if you can set browser cookies\n\nIf you refresh an auth session, you have to make sure that new session makes it to the browser cookie jar somehow. This is already done by the server-side client via `Set-Cookie` headers, and by the browser-side client during `_useSession()` as shown by the code snippet I pasted directly out of the `GoTrueClient` source code.\n\nThe more open-ended question is how you want other contexts to behave. You might take a simple approach to Edge Functions and opt to **never refresh an auth session inside an Edge Function.** If the session is expired, it has to fail and communicate why it failed in its response, so your web app can retry with the new session. To implement this simple strategy, create new client instances in your Edge Functions with the following option:\n\n```ts\nexport const supabase = createClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n    {\n        auth: {\n            autoRefreshToken: false\n        }\n    }\n)\n```\n\nI suppose you could refresh auth sessions in Edge Functions **if you passed the new session all the way back up to the browser** via `Set-Cookie` headers. This might be simple enough if the Edge Function was called directly from the browser, but it would require writing the headers several times if the Edge Function was called from your server; the cookies would need to be set first in the response to the calling _server component, action or API route,_ then set again by the server in its _response to the browser._ Whether that's a fruitful or worthwhile path to explore, I'm not so sure right now.\n\n### 3. Lean towards using the \"local\" scope when signing users out\n\nIf your users have multiple sessions at once across their devices, or even in automation contexts, they probably expect to log out from one session and expect the rest to continue working. The default behaviour when running `supabase.auth.signOut()` however is to revoke all sessions for that user. We can change this to only revoke the one session, thus preventing undue `Invalid Refresh Token` nightmares, with a simple option passed to the sign out call:\n\n```ts\nawait supabase.auth.signOut({ scope: \"local\" })\n```\n\n\u003Cbr>\n\nThanks for reading my ted talk. This is an important problem and I hope we can get an agreed-upon solution into official docs. Please connect on LinkedIn, GitHub, or get in touch with an email. Peace!","src/collections/blog/supabase_auth_sessions_ssr.md","7811a45c769cf8c5",{"html":73,"metadata":74},"\u003Cp>Pasting some thoughts which I shared regarding an issue on the \u003Ccode>/supabase/ssr\u003C/code> GitHub repo. The issue is still active, and you can follow the discussion here: \u003Ca href=\"https://github.com/supabase/ssr/issues/68\">AuthApiError: Invalid Refresh Token: Refresh Token Not Found when refreshing token in middleware\u003C/a>.\u003C/p>\n\u003Cp>Developers building NextJS apps which refresh Supabase Auth sessions on both the server and client are seeing their users logged out seemingly randomly. This is a massive problem that needs to be understood and solved, but I try to explain that itâ€™s not random, and that there are some things we can do about it starting now.\u003C/p>\n\u003Cp>Itâ€™s my feeling that having a deeper understanding of Supabase in general really is our path towards being more robust in our app dev work. Here we go!\u003C/p>\n\u003Ch2 id=\"the-issue-beneath-the-issue\">The Issue Beneath The Issue\u003C/h2>\n\u003Cp>I first encountered the \u003Cem>â€œissue beneath the issueâ€\u003C/em> in the \u003Ccode>/supabase/auth-js\u003C/code> repo --- that is, shared state between Supabase \u003Ccode>GoTrueClient\u003C/code> instances is no longer just in one browser, it needs to be managed across \u003Cstrong>networked instances\u003C/strong>. The issue there was about the expectation that browser-side \u003Ccode>onAuthStateChange()\u003C/code> should listen for \u003Cstrong>all auth state updates\u003C/strong> including on the server, which is not what that function does.\u003C/p>\n\u003Cp>Iâ€™m going to explain what that function actually does, and address our new modern issue of syncing auth state across increasingly distributed services that canâ€™t always stay subscribed to eachother in a direct â€œpub-subâ€ sort of way. The problem at the heart of this is \u003Cstrong>race conditions emerging\u003C/strong> between \u003Ccode>GoTrueClient\u003C/code> instances, wherein the client that lost the race to refresh the shared session fails with \u003Ccode>Invalid Refresh Token\u003C/code>.\u003C/p>\n\u003Cp>We need to solve the problem of synced session state between server-side and browser-side supabase clients. However, the behaviour of \u003Ccode>onAuthStateChange()\u003C/code> is a feature not a bug, and the solution to our problem lies elsewhere in our application architecture.\u003C/p>\n\u003Ch2 id=\"onauthstatechange-is-only-in-the-browser-by-design\">onAuthStateChange() is only in the browser, by design\u003C/h2>\n\u003Cp>The \u003Ccode>GoTrueClient.onAuthStateChange()\u003C/code> function was designed back in the browser-only days of SPAs, to sync \u003Cstrong>across tabs and windows\u003C/strong> that may be running multiple instances of a web app at the same time. If you dig into the source code of the auth client, youâ€™ll see that all instances of the client running on the same browser (across tabs and windows) take advantage of the \u003Ca href=\"https://developer.mozilla.org/en-US/blog/exploring-the-broadcast-channel-api-for-cross-tab-communication/\">broadcast channel API\u003C/a> and a shared locking mechanism to ensure that when itâ€™s time to refresh the session, it takes place \u003Cstrong>only once, done by a single client instance.\u003C/strong> Here is a common \u003Ccode>useEffect()\u003C/code> to handle auth state changes in a React SPA:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"ts\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">useEffect\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(() \u003C/span>\u003Cspan style=\"color:#F97583\">=>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">  // Fetch logged in user on mount\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  supabase.auth.\u003C/span>\u003Cspan style=\"color:#B392F0\">getUser\u003C/span>\u003Cspan style=\"color:#E1E4E8\">().\u003C/span>\u003Cspan style=\"color:#B392F0\">then\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#FFAB70\">response\u003C/span>\u003Cspan style=\"color:#F97583\"> =>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">    setUser\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(response.data.user)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  })\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">  // Track any changes in local state\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">  const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> listener\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> supabase.auth.\u003C/span>\u003Cspan style=\"color:#B392F0\">onAuthStateChange\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">async\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#FFAB70\">event\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">session\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) \u003C/span>\u003Cspan style=\"color:#F97583\">=>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">    setUser\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(session?.user \u003C/span>\u003Cspan style=\"color:#F97583\">||\u003C/span>\u003Cspan style=\"color:#79B8FF\"> null\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  })\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">  return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> () \u003C/span>\u003Cspan style=\"color:#F97583\">=>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> listener.data.subscription.\u003C/span>\u003Cspan style=\"color:#B392F0\">unsubscribe\u003C/span>\u003Cspan style=\"color:#E1E4E8\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}, [])\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"how-a-shared-lock-prevents-race-conditions\">How a shared lock prevents race conditions\u003C/h2>\n\u003Cp>Almost every function call that goes to the GoTrue server needs to acquire the lock first. Letâ€™s take this example of the \u003Ccode>GoTrueClient.getUser()\u003C/code> method:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"ts\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// getUser()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> result\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#F97583\"> await\u003C/span>\u003Cspan style=\"color:#79B8FF\"> this\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.\u003C/span>\u003Cspan style=\"color:#B392F0\">_acquireLock\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">-\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#F97583\">async\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> () \u003C/span>\u003Cspan style=\"color:#F97583\">=>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">      return\u003C/span>\u003Cspan style=\"color:#F97583\"> await\u003C/span>\u003Cspan style=\"color:#79B8FF\"> this\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.\u003C/span>\u003Cspan style=\"color:#B392F0\">_getUser\u003C/span>\u003Cspan style=\"color:#E1E4E8\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">})\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>So, in the browser-only paradigm of SPAs in early 2020s, the session refresh happens in the context that this client is the only one manipulating auth state for our current user, and \u003Cstrong>we can be sure of that because of the locking across all tabs and windows.\u003C/strong>\u003C/p>\n\u003Cp>\u003Ccode>getUser()\u003C/code> actually makes a network call every time, it never pulls the user from the local storage interface like it does with \u003Ccode>getSession()\u003C/code>. So in order to fetch the user, the function closure needs to make sure it sends a non-expired access token, and to do that, \u003Ccode>getUser()\u003C/code> calls an internal method \u003Ccode>_getUser()\u003C/code>, which itself uses a \u003Ccode>_useSession()\u003C/code> wrapper that makes a non-expired access token available:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"ts\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// _getUser()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">return\u003C/span>\u003Cspan style=\"color:#F97583\"> await\u003C/span>\u003Cspan style=\"color:#79B8FF\"> this\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.\u003C/span>\u003Cspan style=\"color:#B392F0\">_useSession\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">async\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#FFAB70\">result\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) \u003C/span>\u003Cspan style=\"color:#F97583\">=>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        const\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> { \u003C/span>\u003Cspan style=\"color:#79B8FF\">data\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">error\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> } \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> result\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (error) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">          throw\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> error\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        // returns an error if there is no access_token or custom authorization header\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#F97583\">!\u003C/span>\u003Cspan style=\"color:#E1E4E8\">data.session?.access_token \u003C/span>\u003Cspan style=\"color:#F97583\">&#x26;&#x26;\u003C/span>\u003Cspan style=\"color:#F97583\"> !\u003C/span>\u003Cspan style=\"color:#79B8FF\">this\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.hasCustomAuthorizationHeader) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">          return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> { data: { user: \u003C/span>\u003Cspan style=\"color:#79B8FF\">null\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> }, error: \u003C/span>\u003Cspan style=\"color:#F97583\">new\u003C/span>\u003Cspan style=\"color:#B392F0\"> AuthSessionMissingError\u003C/span>\u003Cspan style=\"color:#E1E4E8\">() }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        return\u003C/span>\u003Cspan style=\"color:#F97583\"> await\u003C/span>\u003Cspan style=\"color:#B392F0\"> _request\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#79B8FF\">this\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.fetch, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'GET'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">`${\u003C/span>\u003Cspan style=\"color:#79B8FF\">this\u003C/span>\u003Cspan style=\"color:#9ECBFF\">.\u003C/span>\u003Cspan style=\"color:#E1E4E8\">url\u003C/span>\u003Cspan style=\"color:#9ECBFF\">}/user`\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          headers: \u003C/span>\u003Cspan style=\"color:#79B8FF\">this\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.headers,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          jwt: data.session?.access_token \u003C/span>\u003Cspan style=\"color:#F97583\">??\u003C/span>\u003Cspan style=\"color:#79B8FF\"> undefined\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          xform: _userResponse,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        })\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">})\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>What does the \u003Ccode>_useSession()\u003C/code> higher-order function wrapper do you ask? We can infer from context that it takes the passed callback function, and makes sure it has access to an up-to-date access token before calling it. But the details are so important to understand that Iâ€™m going to paste the function here with some less important parts edited out:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"ts\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// _useSession() and __loadSession()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">/**\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">   * Use instead of getSession() inside the library. It is\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">   * semantically usually what you want, as getting a session involves some\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">   * processing afterwards that requires only one client operating on the\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">   * session at once across multiple tabs or processes.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">   */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  private async \u003C/span>\u003Cspan style=\"color:#B392F0\">_useSession\u003C/span>\u003Cspan style=\"color:#E1E4E8\">&#x3C;\u003C/span>\u003Cspan style=\"color:#B392F0\">R\u003C/span>\u003Cspan style=\"color:#E1E4E8\">>(fn): \u003C/span>\u003Cspan style=\"color:#79B8FF\">Promise\u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"color:#79B8FF\">R\u003C/span>\u003Cspan style=\"color:#F97583\">>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    try {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">      const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> result\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#F97583\"> await\u003C/span>\u003Cspan style=\"color:#79B8FF\"> this\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.\u003C/span>\u003Cspan style=\"color:#B392F0\">__loadSession\u003C/span>\u003Cspan style=\"color:#E1E4E8\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">      return\u003C/span>\u003Cspan style=\"color:#F97583\"> await\u003C/span>\u003Cspan style=\"color:#B392F0\"> fn\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(result)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    } finally {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">      this\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.\u003C/span>\u003Cspan style=\"color:#B392F0\">_debug\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'#_useSession'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'end'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">  /**\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">   * NEVER USE DIRECTLY!\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">   *\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">   * Always use useSession().\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">   */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  private async \u003C/span>\u003Cspan style=\"color:#B392F0\">__loadSession\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(): \u003C/span>\u003Cspan style=\"color:#79B8FF\">Promise\u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"color:#E1E4E8\">{\u003C/span>\u003Cspan style=\"color:#B392F0\">data\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: {\u003C/span>\u003Cspan style=\"color:#B392F0\">session\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: Session}, \u003C/span>\u003Cspan style=\"color:#B392F0\">error\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">null\u003C/span>\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003Cspan style=\"color:#F97583\">>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    try {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">      let\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> currentSession\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#B392F0\"> Session\u003C/span>\u003Cspan style=\"color:#F97583\"> |\u003C/span>\u003Cspan style=\"color:#79B8FF\"> null\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#79B8FF\"> null\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">      // try to get session information in the default place it should be, almost always from browser cookies API\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      currentSession \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#F97583\"> await\u003C/span>\u003Cspan style=\"color:#B392F0\"> getItemAsync\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#79B8FF\">this\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.storage, \u003C/span>\u003Cspan style=\"color:#79B8FF\">this\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.storageKey)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">      if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#F97583\">!\u003C/span>\u003Cspan style=\"color:#E1E4E8\">currentSession) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> { data: { session: \u003C/span>\u003Cspan style=\"color:#79B8FF\">null\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> }, error: \u003C/span>\u003Cspan style=\"color:#79B8FF\">null\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">      // A session is considered expired before the access token _actually_\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">      // expires. When the autoRefreshToken option is off (or when the tab is\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">      // in the background), very eager users of getSession() -- like\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">      // realtime-js -- might send a valid JWT which will expire by the time it\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">      // reaches the server.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">      const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> hasExpired\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> currentSession.expires_at\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        ?\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> currentSession.expires_at \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 1000\u003C/span>\u003Cspan style=\"color:#F97583\"> -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Date.\u003C/span>\u003Cspan style=\"color:#B392F0\">now\u003C/span>\u003Cspan style=\"color:#E1E4E8\">() \u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"color:#79B8FF\"> EXPIRY_MARGIN_MS\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        :\u003C/span>\u003Cspan style=\"color:#79B8FF\"> false\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">      if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#F97583\">!\u003C/span>\u003Cspan style=\"color:#E1E4E8\">hasExpired) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> { data: { session: currentSession }, error: \u003C/span>\u003Cspan style=\"color:#79B8FF\">null\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">      const\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> { \u003C/span>\u003Cspan style=\"color:#79B8FF\">session\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">error\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> } \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#F97583\"> await\u003C/span>\u003Cspan style=\"color:#79B8FF\"> this\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.\u003C/span>\u003Cspan style=\"color:#B392F0\">_callRefreshToken\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(currentSession.refresh_token)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">      if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (error) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> { data: { session: \u003C/span>\u003Cspan style=\"color:#79B8FF\">null\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> }, error }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">      return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> { data: { session }, error: \u003C/span>\u003Cspan style=\"color:#79B8FF\">null\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    } finally {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">      this\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.\u003C/span>\u003Cspan style=\"color:#B392F0\">_debug\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'#__loadSession()'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'end'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  }\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>We see close to the bottom that itâ€™s here, in the context of \u003Ccode>_acquireLock()\u003C/code>, then inside \u003Ccode>_useSession()\u003C/code>, the client notices that the session is expired (or about to expire), and calls \u003Ccode>this._callRefreshToken(currentSession.refresh_token)\u003C/code>. All function calls to \u003Ccode>getUser()\u003C/code>, \u003Ccode>signIn()\u003C/code> etc. by other client instances in other tabs and windows \u003Cstrong>must wait for that lock to become released\u003C/strong> and wait their turn until the new refresh/access tokens are made available. Once the session is refreshed, the lock is released and an event is broadcasted over the channel, at which point the other consuming clients execute their \u003Ccode>onAuthStateChange()\u003C/code> callbacks.\u003C/p>\n\u003Cp>Hereâ€™s the gist of \u003Ccode>_callRefreshToken()\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"ts\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// _callRefreshToken()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">     const\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> { \u003C/span>\u003Cspan style=\"color:#79B8FF\">data\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">error\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> } \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#F97583\"> await\u003C/span>\u003Cspan style=\"color:#79B8FF\"> this\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.\u003C/span>\u003Cspan style=\"color:#B392F0\">_refreshAccessToken\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(refreshToken)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">      if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (error) \u003C/span>\u003Cspan style=\"color:#F97583\">throw\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> error\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">      if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#F97583\">!\u003C/span>\u003Cspan style=\"color:#E1E4E8\">data.session) \u003C/span>\u003Cspan style=\"color:#F97583\">throw\u003C/span>\u003Cspan style=\"color:#F97583\"> new\u003C/span>\u003Cspan style=\"color:#B392F0\"> AuthSessionMissingError\u003C/span>\u003Cspan style=\"color:#E1E4E8\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">      await\u003C/span>\u003Cspan style=\"color:#79B8FF\"> this\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.\u003C/span>\u003Cspan style=\"color:#B392F0\">_saveSession\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(data.session)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">      await\u003C/span>\u003Cspan style=\"color:#79B8FF\"> this\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.\u003C/span>\u003Cspan style=\"color:#B392F0\">_notifyAllSubscribers\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'TOKEN_REFRESHED'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, data.session)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Itâ€™s essential to understand that the key to this method working so well in SPAs is \u003Cstrong>every consuming client is connected over a secure communication method,\u003C/strong> the \u003Ccode>BroadcastChannel\u003C/code>, which makes the new session \u003Cstrong>available instantly\u003C/strong>.\u003C/p>\n\u003Ch2 id=\"the-challenge-of-syncing-auth-session-state-across-varied-consumers\">The challenge of syncing auth session state across varied consumers\u003C/h2>\n\u003Cp>Great, now we understand how the supabase engineers tackled this thorny problem in browser-only bygone eras. The thing is, in a distributed system thatâ€™s instantiating clients in multiple places at once (browser, NextJS server, edge functions, cron jobs, etc), broadcasting these stateful updates to all clients becomes impossible.\u003C/p>\n\u003Cp>Example: I have a supabase client running inside an edge function and it determines that itâ€™s time to refresh the session. Itâ€™ll receive that new session and finish the work itâ€™s doing, but it has no way to share that new session info with my web app in the browser, which is now expired and failing. ğŸ˜¢\u003C/p>\n\u003Cp>This is just a reality of distributed systems; in absence of a shared lock, multiple clients try and refresh the session at the same time. One will win, get a valid new session, and the other one will fail with \u003Ccode>AuthApiError: Invalid Refresh Token: Refresh Token Not Found\u003C/code>.\u003C/p>\n\u003Ch2 id=\"looking-ahead-to-solutions\">Looking ahead to solutions\u003C/h2>\n\u003Cp>Before we get to handling the \u003Ccode>Invalid Refresh Token\u003C/code> nightmare, letâ€™s fix the basic issue and keep the browser context synced after server-side \u003Ccode>signIn()\u003C/code> and \u003Ccode>signOut()\u003C/code>.\u003C/p>\n\u003Cp>In your server actions for auth (I call them \u003Ccode>signIn()\u003C/code> and \u003Ccode>signOut()\u003C/code>), add a query param of \u003Ccode>?refresh_browser_auth\u003C/code> to the url you redirect to on completion:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"ts\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// \"/app/auth/actions.ts\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">export\u003C/span>\u003Cspan style=\"color:#F97583\"> async\u003C/span>\u003Cspan style=\"color:#F97583\"> function\u003C/span>\u003Cspan style=\"color:#B392F0\"> signIn\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#FFAB70\">currentState\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> { \u003C/span>\u003Cspan style=\"color:#FFAB70\">message\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> string\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> }, \u003C/span>\u003Cspan style=\"color:#FFAB70\">formData\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#B392F0\"> FormData\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> supabase\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#F97583\"> await\u003C/span>\u003Cspan style=\"color:#B392F0\"> createClient\u003C/span>\u003Cspan style=\"color:#E1E4E8\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> data\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        email: formData.\u003C/span>\u003Cspan style=\"color:#B392F0\">get\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'email'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) \u003C/span>\u003Cspan style=\"color:#F97583\">as\u003C/span>\u003Cspan style=\"color:#79B8FF\"> string\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        password: formData.\u003C/span>\u003Cspan style=\"color:#B392F0\">get\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'password'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) \u003C/span>\u003Cspan style=\"color:#F97583\">as\u003C/span>\u003Cspan style=\"color:#79B8FF\"> string\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    const\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> { \u003C/span>\u003Cspan style=\"color:#79B8FF\">error\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> } \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#F97583\"> await\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> supabase.auth.\u003C/span>\u003Cspan style=\"color:#B392F0\">signInWithPassword\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(data)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (error) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> { message: error.message }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">    revalidatePath\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'/'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'layout'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">    redirect\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"/?refresh_browser_auth\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">export\u003C/span>\u003Cspan style=\"color:#F97583\"> async\u003C/span>\u003Cspan style=\"color:#F97583\"> function\u003C/span>\u003Cspan style=\"color:#B392F0\"> signout\u003C/span>\u003Cspan style=\"color:#E1E4E8\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> supabase\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#F97583\"> await\u003C/span>\u003Cspan style=\"color:#B392F0\"> createClient\u003C/span>\u003Cspan style=\"color:#E1E4E8\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    await\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> supabase.auth.\u003C/span>\u003Cspan style=\"color:#B392F0\">signOut\u003C/span>\u003Cspan style=\"color:#E1E4E8\">({ scope: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"local\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> })\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">    redirect\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"/?refresh_browser_auth\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Take the following example \u003Ccode>useEffect()\u003C/code> that handles the query param. Itâ€™s rendered as its own component to be able to compose inside a shared \u003Ccode>&#x3C;Suspense>\u003C/code> boundary alongside other utilites:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"ts\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// /components/UrlAuthSync.tsx\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">\"use client\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> { useEffect } \u003C/span>\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"react\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> { useSearchParams, useRouter, usePathname } \u003C/span>\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"next/navigation\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> { useAppContext } \u003C/span>\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"@/lib/contexts/appContext\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">export\u003C/span>\u003Cspan style=\"color:#F97583\"> default\u003C/span>\u003Cspan style=\"color:#F97583\"> function\u003C/span>\u003Cspan style=\"color:#B392F0\"> UrlAuthSync\u003C/span>\u003Cspan style=\"color:#E1E4E8\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> pathname\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#B392F0\"> usePathname\u003C/span>\u003Cspan style=\"color:#E1E4E8\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> searchParams\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#B392F0\"> useSearchParams\u003C/span>\u003Cspan style=\"color:#E1E4E8\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> router\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#B392F0\"> useRouter\u003C/span>\u003Cspan style=\"color:#E1E4E8\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    const\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> { \u003C/span>\u003Cspan style=\"color:#79B8FF\">supabase\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">mergeState\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> } \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#B392F0\"> useAppContext\u003C/span>\u003Cspan style=\"color:#E1E4E8\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">    useEffect\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(() \u003C/span>\u003Cspan style=\"color:#F97583\">=>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (searchParams.\u003C/span>\u003Cspan style=\"color:#B392F0\">has\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"refresh_browser_auth\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            supabase.auth.\u003C/span>\u003Cspan style=\"color:#B392F0\">getSession\u003C/span>\u003Cspan style=\"color:#E1E4E8\">().\u003C/span>\u003Cspan style=\"color:#B392F0\">then\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#FFAB70\">response\u003C/span>\u003Cspan style=\"color:#F97583\"> =>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                router.\u003C/span>\u003Cspan style=\"color:#B392F0\">replace\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(pathname)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">                mergeState\u003C/span>\u003Cspan style=\"color:#E1E4E8\">({ user: response.data.session?.user \u003C/span>\u003Cspan style=\"color:#F97583\">||\u003C/span>\u003Cspan style=\"color:#79B8FF\"> null\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> })\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            })\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }, [pathname, searchParams, router, mergeState, supabase.auth])\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> &#x3C;>&#x3C;/>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Imported and rendered in root layout:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"ts\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// /app/layout.tsx\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> UrlAuthSync \u003C/span>\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"@/components/UrlAuthSync\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// ...other imports and logic\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">export\u003C/span>\u003Cspan style=\"color:#F97583\"> default\u003C/span>\u003Cspan style=\"color:#F97583\"> function\u003C/span>\u003Cspan style=\"color:#B392F0\"> RootLayout\u003C/span>\u003Cspan style=\"color:#E1E4E8\">({ \u003C/span>\u003Cspan style=\"color:#FFAB70\">children\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> }) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">  return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    &#x3C;\u003C/span>\u003Cspan style=\"color:#E1E4E8\">html lang\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"en\"\u003C/span>\u003Cspan style=\"color:#F97583\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      &#x3C;\u003C/span>\u003Cspan style=\"color:#B392F0\">body\u003C/span>\u003Cspan style=\"color:#E1E4E8\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        &#x3C;\u003C/span>\u003Cspan style=\"color:#B392F0\">AppContextProvider\u003C/span>\u003Cspan style=\"color:#E1E4E8\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          {\u003C/span>\u003Cspan style=\"color:#FFAB70\">children\u003C/span>\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          &#x3C;\u003C/span>\u003Cspan style=\"color:#B392F0\">Suspense\u003C/span>\u003Cspan style=\"color:#E1E4E8\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            &#x3C;\u003C/span>\u003Cspan style=\"color:#E1E4E8\">UrlToast \u003C/span>\u003Cspan style=\"color:#F97583\">/>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            &#x3C;\u003C/span>\u003Cspan style=\"color:#E1E4E8\">UrlAuthSync \u003C/span>\u003Cspan style=\"color:#F97583\">/>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            &#x3C;\u003C/span>\u003Cspan style=\"color:#E1E4E8\">Toaster \u003C/span>\u003Cspan style=\"color:#F97583\">/>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">          &#x3C;/\u003C/span>\u003Cspan style=\"color:#E1E4E8\">Suspense\u003C/span>\u003Cspan style=\"color:#F97583\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        &#x3C;/\u003C/span>\u003Cspan style=\"color:#E1E4E8\">AppContextProvider\u003C/span>\u003Cspan style=\"color:#F97583\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">      &#x3C;/\u003C/span>\u003Cspan style=\"color:#E1E4E8\">body\u003C/span>\u003Cspan style=\"color:#F97583\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    &#x3C;/\u003C/span>\u003Cspan style=\"color:#E1E4E8\">html\u003C/span>\u003Cspan style=\"color:#F97583\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  );\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>And that takes care of that. A flag in the url to tell the browser context that it needs to refresh in these specific scenarios.\u003C/p>\n\u003Cp>Note Iâ€™m using \u003Ccode>getSession()\u003C/code> in this case, which is often discouraged by the supabase docs because it can return a stale session directly out of local storage. But in this case, directly after a user signin or signout, \u003Cstrong>itâ€™ll be up-to-date for sure\u003C/strong> so a request to the auth server is unnecessary.\u003C/p>\n\u003Cp>Back to the \u003Ccode>Invalid Refresh Token\u003C/code> nightmare --- What to do about this problem? It seems the supabase team is still figuring this out. I have some ideas:\u003C/p>\n\u003Ch3 id=\"1-treat-the-browser-cookie-jar-as-the-single-point-of-recovery\">1. Treat the browser cookie jar as the single point of recovery\u003C/h3>\n\u003Cp>There are many scenarios that could lead to a supabase client instance being in the \u003Ccode>Invalid Refresh Token\u003C/code> nightmare. Here are some common ones I can think of that might make this a bit more clear:\u003C/p>\n\u003Cul>\n\u003Cli>A server-side client is executing middleware and tries to refresh its session. It lost a race with a browser-side client that refreshed at the exact same moment, and it doesnâ€™t have access to the new session\u003C/li>\n\u003Cli>A browser-side client fires off a \u003Ccode>useQuery()\u003C/code> to supabase and tries to refresh its session. It lost a race with a server-side client that refreshed at the exact same moment, and it doesnâ€™t have access to the new session\u003C/li>\n\u003Cli>A client in an Edge Function tried to refresh its expired session during a long-running background job, only to find that another client used up the shared refresh token in the meantime, and it doesnâ€™t have access to the new session\u003C/li>\n\u003C/ul>\n\u003Cp>In all of these cases, the problem is that there is no shared lock and no shared \u003Ccode>BroadcastChannel\u003C/code>. The clientâ€™s refresh token is completely useless (it can only be exchanged for a new session once, by design) and there is no easy instant access to the new session.\u003C/p>\n\u003Cp>How a supabase client instance ends up in this disaster \u003Cstrong>doesnâ€™t matter.\u003C/strong> What we need to do is \u003Cstrong>write retry logic\u003C/strong> that looks to the browser cookie jar then \u003Cstrong>tries again with the up-to-date session.\u003C/strong>\u003C/p>\n\u003Cp>In all cases --- during the rendering of RSC pages or components, during middleware, during API routes, during server actions, during a browser \u003Ccode>useQuery\u003C/code>, or some Edge Function in a faraway land --- \u003Cstrong>an error message has to make its way back to the calling function in the browser.\u003C/strong> There, we can wait until the new session has made its way into the browser cookies, and retry that page navigation or API call.\u003C/p>\n\u003Cp>In order for this strategy to work, we have to trust that \u003Cstrong>every new session will be stored in browser cookies,\u003C/strong> which takes me to my second recommendation:\u003C/p>\n\u003Ch3 id=\"2-only-refresh-an-auth-session-if-you-can-set-browser-cookies\">2. Only refresh an auth session if you can set browser cookies\u003C/h3>\n\u003Cp>If you refresh an auth session, you have to make sure that new session makes it to the browser cookie jar somehow. This is already done by the server-side client via \u003Ccode>Set-Cookie\u003C/code> headers, and by the browser-side client during \u003Ccode>_useSession()\u003C/code> as shown by the code snippet I pasted directly out of the \u003Ccode>GoTrueClient\u003C/code> source code.\u003C/p>\n\u003Cp>The more open-ended question is how you want other contexts to behave. You might take a simple approach to Edge Functions and opt to \u003Cstrong>never refresh an auth session inside an Edge Function.\u003C/strong> If the session is expired, it has to fail and communicate why it failed in its response, so your web app can retry with the new session. To implement this simple strategy, create new client instances in your Edge Functions with the following option:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"ts\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">export\u003C/span>\u003Cspan style=\"color:#F97583\"> const\u003C/span>\u003Cspan style=\"color:#79B8FF\"> supabase\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#B392F0\"> createClient\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    process.env.\u003C/span>\u003Cspan style=\"color:#79B8FF\">NEXT_PUBLIC_SUPABASE_URL\u003C/span>\u003Cspan style=\"color:#F97583\">!\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    process.env.\u003C/span>\u003Cspan style=\"color:#79B8FF\">NEXT_PUBLIC_SUPABASE_ANON_KEY\u003C/span>\u003Cspan style=\"color:#F97583\">!\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        auth: {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            autoRefreshToken: \u003C/span>\u003Cspan style=\"color:#79B8FF\">false\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>I suppose you could refresh auth sessions in Edge Functions \u003Cstrong>if you passed the new session all the way back up to the browser\u003C/strong> via \u003Ccode>Set-Cookie\u003C/code> headers. This might be simple enough if the Edge Function was called directly from the browser, but it would require writing the headers several times if the Edge Function was called from your server; the cookies would need to be set first in the response to the calling \u003Cem>server component, action or API route,\u003C/em> then set again by the server in its \u003Cem>response to the browser.\u003C/em> Whether thatâ€™s a fruitful or worthwhile path to explore, Iâ€™m not so sure right now.\u003C/p>\n\u003Ch3 id=\"3-lean-towards-using-the-local-scope-when-signing-users-out\">3. Lean towards using the â€œlocalâ€ scope when signing users out\u003C/h3>\n\u003Cp>If your users have multiple sessions at once across their devices, or even in automation contexts, they probably expect to log out from one session and expect the rest to continue working. The default behaviour when running \u003Ccode>supabase.auth.signOut()\u003C/code> however is to revoke all sessions for that user. We can change this to only revoke the one session, thus preventing undue \u003Ccode>Invalid Refresh Token\u003C/code> nightmares, with a simple option passed to the sign out call:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"ts\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">await\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> supabase.auth.\u003C/span>\u003Cspan style=\"color:#B392F0\">signOut\u003C/span>\u003Cspan style=\"color:#E1E4E8\">({ scope: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"local\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> })\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cbr>\n\u003Cp>Thanks for reading my ted talk. This is an important problem and I hope we can get an agreed-upon solution into official docs. Please connect on LinkedIn, GitHub, or get in touch with an email. Peace!\u003C/p>",{"headings":75,"imagePaths":101,"frontmatter":102},[76,79,82,85,88,91,95,98],{"depth":26,"slug":77,"text":78},"the-issue-beneath-the-issue","The Issue Beneath The Issue",{"depth":26,"slug":80,"text":81},"onauthstatechange-is-only-in-the-browser-by-design","onAuthStateChange() is only in the browser, by design",{"depth":26,"slug":83,"text":84},"how-a-shared-lock-prevents-race-conditions","How a shared lock prevents race conditions",{"depth":26,"slug":86,"text":87},"the-challenge-of-syncing-auth-session-state-across-varied-consumers","The challenge of syncing auth session state across varied consumers",{"depth":26,"slug":89,"text":90},"looking-ahead-to-solutions","Looking ahead to solutions",{"depth":92,"slug":93,"text":94},3,"1-treat-the-browser-cookie-jar-as-the-single-point-of-recovery","1. Treat the browser cookie jar as the single point of recovery",{"depth":92,"slug":96,"text":97},"2-only-refresh-an-auth-session-if-you-can-set-browser-cookies","2. Only refresh an auth session if you can set browser cookies",{"depth":92,"slug":99,"text":100},"3-lean-towards-using-the-local-scope-when-signing-users-out","3. Lean towards using the â€œlocalâ€ scope when signing users out",[],{"title":66,"published":15,"datePublished":103,"dateLastUpdated":104},["Date","2025-11-12T00:00:00.000Z"],["Date","2025-11-12T00:00:00.000Z"]]